# 🔍 Как система определяет состояние объектов

## 📊 Текущая архитектура (MVP)

### 1. **Источник данных: Диагностические обследования**

Система **НЕ использует датчики в реальном времени**. Вместо этого данные поступают из:

```
┌─────────────────────────────────────────┐
│  Диагностические обследования           │
│  (Периодические проверки)               │
└──────────────┬──────────────────────────┘
               │
               ▼
    ┌──────────────────────┐
    │  Методы диагностики  │
    │  - VIK (визуальный)  │
    │  - MFL (магнитоскан) │
    │  - UTWM (ультразвук) │
    │  - и другие...       │
    └──────────┬───────────┘
               │
               ▼
    ┌──────────────────────┐
    │  CSV/XLSX файлы       │
    │  с результатами       │
    └──────────┬───────────┘
               │
               ▼
    ┌──────────────────────┐
    │  Импорт в систему      │
    └──────────┬───────────┘
               │
               ▼
    ┌──────────────────────┐
    │  Обработка данных     │
    └──────────────────────┘
```

### 2. **Как определяется статус объекта**

Статус объекта (Critical/Normal) определяется на основе **диагностических данных**:

```python
# Простая логика (текущая реализация)
if объект имеет диагностику с defect_found = True:
    статус = "Critical"
else:
    статус = "Normal"
```

**Где это происходит:**
- Файл: `backend/app/api/v1/objects.py` (строки 124-135)
- Логика: Если у объекта есть хотя бы одна диагностика с найденным дефектом → Critical

### 3. **Как определяется критичность (ML метка)**

Система использует **два подхода**:

#### A. **ML Модель (если обучена)**

```
Входные данные:
├─ param1 (глубина дефекта, мм)
├─ param2 (площадь дефекта, %)
├─ param3 (доп. параметр)
├─ method (метод диагностики)
├─ defect_found (найден ли дефект)
└─ object_year (год постройки объекта)

        ↓
   ML Модель
   (RandomForest)
        ↓
   
Результат:
├─ normal (норма)
├─ medium (средний риск)
└─ high (высокий риск)
```

#### B. **Правила (если ML не обучена)**

```python
# Файл: backend/app/services/import_service.py

def _determine_criticality_by_rules():
    # Анализ описания дефекта
    if "критический" in описание:
        return "high"
    
    # Анализ параметров
    if param1 >= 20.0 мм:  # Глубокая коррозия
        return "high"
    elif param1 >= 10.0 мм:
        return "medium"
    
    return "normal"
```

### 4. **Параметры диагностики**

Каждый метод диагностики имеет свои параметры:

| Метод | param1 | param2 | param3 |
|-------|--------|--------|--------|
| **VIK** (визуальный) | Глубина дефекта (мм) | Площадь (см²) | Длина (м) |
| **MFL** (магнитоскан) | Глубина аномалии (мм) | Ширина (мм) | Длина (м) |
| **UTWM** (ультразвук) | Толщина стенки (мм) | Потеря толщины (%) | Площадь (см²) |
| **VIBRO** (вибрация) | Виброскорость (мм/с) | Частота (Гц) | Ускорение (м/с²) |

### 5. **Полный процесс определения состояния**

```
┌─────────────────────────────────────────────────┐
│  1. Импорт диагностических данных              │
│     (CSV/XLSX файлы)                           │
└──────────────────┬──────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────┐
│  2. Парсинг данных                              │
│     - object_id, method, date                   │
│     - param1, param2, param3                    │
│     - defect_found, defect_description          │
└──────────────────┬──────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────┐
│  3. Определение критичности                     │
│     ├─ ML модель (если обучена)                 │
│     └─ Правила (если ML не обучена)            │
└──────────────────┬──────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────┐
│  4. Сохранение в БД                              │
│     - Diagnostic.ml_label = "high/medium/normal"│
│     - Diagnostic.defect_found = True/False       │
└──────────────────┬──────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────┐
│  5. Определение статуса объекта                 │
│     if есть дефект → status = "Critical"        │
│     else → status = "Normal"                     │
└──────────────────┬──────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────┐
│  6. Отображение в интерфейсе                    │
│     - Карта (красные/зеленые маркеры)          │
│     - Таблица дефектов                          │
│     - Статистика                                │
└─────────────────────────────────────────────────┘
```

## 🔮 Как это может работать с датчиками (будущее)

### Вариант 1: Гибридная система

```
┌─────────────────────────────────────────┐
│  Датчики (реальное время)                │
│  - Давление                              │
│  - Температура                           │
│  - Вибрация                              │
│  - Утечки                                │
└──────────────┬──────────────────────────┘
               │
               ▼
    ┌──────────────────────┐
    │  Периодические       │
    │  диагностики         │
    └──────────┬───────────┘
               │
               ▼
    ┌──────────────────────┐
    │  ML Модель            │
    │  (объединяет данные)   │
    └──────────┬───────────┘
               │
               ▼
    ┌──────────────────────┐
    │  Статус объекта      │
    └──────────────────────┘
```

### Вариант 2: IoT датчики + Edge Computing

```
Датчики на объекте
    ↓
Edge устройство (обработка на месте)
    ↓
Определение аномалий
    ↓
Отправка в облако
    ↓
ML анализ + визуализация
```

## 📋 Текущие данные в системе

### Что хранится:

1. **Объекты (Objects)**
   - Координаты (lat, lon)
   - Тип объекта
   - Год постройки
   - Материал

2. **Диагностики (Diagnostics)**
   - Метод диагностики
   - Дата обследования
   - Параметры (param1, param2, param3)
   - Найден ли дефект
   - Описание дефекта
   - ML метка (normal/medium/high)
   - Оценка качества
   - Условия (температура, влажность, освещенность)

### Как это используется:

```python
# Определение статуса объекта
def get_object_status(object_id):
    # Проверяем последнюю диагностику
    last_diagnostic = get_last_diagnostic(object_id)
    
    if last_diagnostic.defect_found:
        # Проверяем критичность
        if last_diagnostic.ml_label == "high":
            return "Critical"  # Красный маркер на карте
        elif last_diagnostic.ml_label == "medium":
            return "Warning"   # Оранжевый маркер
        else:
            return "Normal"     # Зеленый маркер
    else:
        return "Normal"
```

## 🎯 Итог

**Текущая система:**
- ✅ Данные из **периодических диагностических обследований**
- ✅ Импорт через **CSV/XLSX файлы**
- ✅ Определение состояния через **ML модель + правила**
- ✅ Статус объекта = есть ли дефекты в диагностиках

**Будущее развитие:**
- 🔮 Интеграция с **IoT датчиками** для мониторинга в реальном времени
- 🔮 **Edge computing** для обработки на месте
- 🔮 **Предиктивная аналитика** для прогнозирования дефектов
- 🔮 **Автоматические оповещения** при обнаружении аномалий

